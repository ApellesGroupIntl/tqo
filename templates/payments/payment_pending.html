{% extends 'base.html' %}

{% block extra_head %}
<style>
  .payment-status {
    min-height: 60vh;
    display: flex;
    align-items: center;
  }
  .status-card {
    border-radius: 12px;
    box-shadow: 0 6px 15px rgba(0,0,0,0.1);
    max-width: 500px;
    margin: 0 auto;
    text-align: center;
    padding: 2rem;
  }
  .status-icon {
    font-size: 3rem;
    color: #6c5ce7;
    margin-bottom: 1.5rem;
  }
  .status-message {
    margin-bottom: 2rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="payment-status">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-md-8">
        <div class="status-card">
          <div class="status-icon">
            <i class="fas fa-mobile-alt"></i>
          </div>
          <h3 class="mb-3">Payment Request Sent</h3>
          <p class="status-message">
            We've sent an STK Push request to <strong>{{ payment.phone }}</strong>.
            Please check your phone and enter your M-Pesa PIN to complete the payment.
          </p>

          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            Transaction ID: {{ payment.transaction_id }}
          </div>

          <div id="paymentStatus" class="mt-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Waiting for payment confirmation...</p>
          </div>

          <div class="mt-4">
            <a href="{% url 'events:event_detail' event.id %}" class="btn btn-outline-secondary me-2">
              <i class="fas fa-arrow-left me-1"></i> Back to Event
            </a>
            <a href="{% url 'dashboard' %}" class="btn btn-outline-primary">
              <i class="fas fa-home me-1"></i> Go to Dashboard
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Poll for payment status
function checkPaymentStatus(checkoutRequestId) {
  fetch(`/payments/check-status/?checkout_request_id=${checkoutRequestId}`)
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        window.location.href = "{% url 'payments:payment_success' payment.transaction_id %}";
      } else if (data.status === 'pending') {
        setTimeout(() => checkPaymentStatus(checkoutRequestId), 3000);
      } else {
        document.getElementById('paymentStatus').innerHTML = `
          <div class="alert alert-danger">
            <i class="fas fa-times-circle me-2"></i>
            Payment not completed. Please try again.
          </div>
        `;
      }
    });
}

// Start polling when page loads
document.addEventListener('DOMContentLoaded', function() {
  checkPaymentStatus("{{ payment.transaction_id }}");
});
</script>
{% endblock %}
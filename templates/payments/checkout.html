{% extends "base.html" %}
{% block content %}
<div class="container py-3">
    <div class="row justify-content-center">
        <div class="col-lg-6 col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white py-2 text-center">
                    <h5 class="mb-0">
                        <i class="fas fa-ticket-alt me-2"></i>Purchase Tickets: {{ event.name }}
                    </h5>
                </div>

                <div class="card-body p-3">
                    <!-- Compact Event Details -->
                    <div class="event-details mb-3 p-2 border rounded bg-light">
                        <div class="d-flex flex-wrap small text-muted mb-1">
                            <span class="me-3"><i class="far fa-calendar-alt me-1"></i>{{ event.date }}</span>
                            <span><i class="fas fa-map-marker-alt me-1"></i>{{ event.location }}</span>
                        </div>
                        {% if event.description %}
                        <p class="small mb-0 text-muted">{{ event.description|truncatechars:120 }}</p>
                        {% endif %}
                    </div>

                    <!-- Order Summary -->
                    <div class="order-summary mb-3 p-2 border rounded">
                        <h6 class="border-bottom pb-1 mb-2 small"><strong>Your Order</strong></h6>
                        <table class="table table-sm table-borderless mb-1">
                            <tbody>
                                <tr>
                                    <td class="text-muted small">Ticket Type:</td>
                                        <td class="small">{{ ticket.name }}</td>

<!--                                    <td class="small">{{ event.ticket_type }}</td>-->
                                </tr>
                                <tr>
                                    <td class="text-muted small">Quantity:</td>
                                    <td class="small">{{ quantity }}</td>
                                </tr>
                                <tr>
                                    <td class="text-muted small">Price Each:</td>
                                    <td class="small">KES {{ ticket.price }}</td>
                                </tr>
                                <tr class="border-top">
                                    <td class="small"><strong>Total Amount:</strong></td>
                                    <td class="text-success fw-bold">KES {{ total_price }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Payment Form -->
                    <form id="mpesaPaymentForm" class="mt-3">
                        {% csrf_token %}
<!--                        <input type="hidden" name="ticket_type" value="{{ event.id }}">-->

                        <input type="hidden" name="event_id" value="{{ event.id }}">
                        <input type="hidden" name="amount" value="{{ total_price }}">

                        <div class="mb-2">
                            <label for="phone" class="form-label small mb-1">M-Pesa Phone Number</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light"><i class="fas fa-mobile-alt"></i></span>
                                <input type="text" name="phone" id="phone" class="form-control form-control-sm"
                                       placeholder="2547XXXXXXXX" required>
                            </div>
                            <div class="form-text small">Format: 2547XXXXXXXX (M-Pesa registered number)</div>
                        </div>

                        <div id="paymentStatus" class="alert alert-info d-none">
                            <div class="d-flex align-items-center">
                                <div class="spinner-border spinner-border-sm me-2" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <span id="statusMessage">Initiating payment request...</span>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-success w-100 mt-2 py-2" id="submitBtn">
                            <i class="fas fa-lock me-1"></i>Complete Payment - KES {{ total_price|floatformat:0 }}
                        </button>
                    </form>
                </div>

                <div class="card-footer bg-light py-2 text-center small">
                    <i class="fas fa-shield-alt text-success me-1"></i>Secure checkout powered by APELLES GROUP INTL
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Payment Processing Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Complete Payment</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center py-4">
                <div class="mb-3">
                    <i class="fas fa-mobile-alt fa-4x text-primary mb-3"></i>
                    <h4>Check Your Phone</h4>
                    <p class="mb-0">We've sent an STK Push request to <strong id="displayPhone"></strong></p>
                    <p>Enter your M-Pesa PIN to complete payment</p>
                </div>
                <div class="progress mb-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                </div>
                <div id="paymentResult"></div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // DOM Elements
  const form = document.getElementById('mpesaPaymentForm');
  const submitBtn = document.getElementById('submitBtn');
  const phoneInput = document.getElementById('phone');
  const amountInput = document.querySelector('input[name="amount"]');
  const eventInput = document.querySelector('input[name="event_id"]');
  const paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
  const displayPhone = document.getElementById('displayPhone');
  const statusMessage = document.getElementById('statusMessage');
  const paymentResult = document.getElementById('paymentResult');
  const paymentStatus = document.getElementById('paymentStatus');

  // CSRF Token
  const csrftoken = getCookie('csrftoken');

  // Phone Number Utilities
  function normalizePhone(phone) {
    phone = (phone || '').replace(/\D/g, '');
    if (phone.startsWith('0') && phone.length === 10) return '254' + phone.slice(1);
    if (phone.startsWith('7') && phone.length === 9) return '254' + phone;
    if (phone.startsWith('+254') && phone.length === 13) return phone.slice(1);
    return phone;
  }

  function validatePhone(phone) {
    return /^2547\d{8}$/.test(phone);
  }

  // Payment Status Polling
  async function pollPaymentStatus(checkoutRequestId) {
    const maxAttempts = 12;
    const baseDelay = 2000;
    let attempt = 0;

    while (attempt < maxAttempts) {
      attempt++;
      updateStatus(`Checking payment status (${attempt}/${maxAttempts})...`, 'info');

      try {
        const response = await fetch(`/payments/check-status/?checkout_request_id=${checkoutRequestId}`, {
          method: 'GET',
          headers: { 'X-CSRFToken': csrftoken }
        });

        if (!response.ok) throw new Error(`Server error: ${response.status}`);

        const data = await response.json();

        if (data.status === 'success') {
          showResult('success', 'Payment complete â€” Redirecting...');
          setTimeout(() => window.location.href = `/payments/success/${data.transaction_id}/`, 1500);
          return true;
        }

        if (data.status === 'failed') {
          throw new Error(data.message || 'Payment failed');
        }

        // Exponential backoff
        await new Promise(r => setTimeout(r, baseDelay * Math.pow(1.3, attempt)));
      } catch (error) {
        console.error('Polling error:', error);
        if (attempt >= maxAttempts) {
          showResult('warning', 'Payment is taking longer than usual. Please check your M-Pesa messages.');
          return false;
        }
      }
    }
  }

  // UI Helpers
  function updateStatus(message, type = 'info') {
    statusMessage.textContent = message;
    paymentStatus.className = `alert alert-${type}`;
  }

  function showResult(type, message) {
    paymentResult.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
  }

  function resetFormState() {
    submitBtn.disabled = false;
    paymentStatus.classList.add('d-none');
  }

  // Form Submission
  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    submitBtn.disabled = true;

    const phone = normalizePhone(phoneInput.value);
    const amount = amountInput.value;
    const eventId = eventInput.value;

    // Validation
    if (!validatePhone(phone)) {
      alert('Please enter a valid M-Pesa number in format 2547XXXXXXXX');
      submitBtn.disabled = false;
      return;
    }

    if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
      alert('Please enter a valid amount');
      submitBtn.disabled = false;
      return;
    }

    // Show payment modal
    displayPhone.textContent = phone;
    paymentModal.show();
    updateStatus('Initiating payment request...', 'info');

    try {
      // Initiate STK Push
      const response = await fetch('/payments/initiate-stk-push/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken
          Authorization:
        },
        body: JSON.stringify({ phone, amount, event_id: eventId })
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.message || `Payment failed (HTTP ${response.status})`);
      }

      const data = await response.json();
      if (!data.success) throw new Error(data.message || 'Payment initiation failed');

      // Start polling for payment status
      updateStatus('STK Push sent. Please enter your M-Pesa PIN on your phone.', 'info');
      await pollPaymentStatus(data.checkout_request_id);

    } catch (error) {
      console.error('Payment error:', error);
      updateStatus(error.message, 'danger');
      showResult('danger', error.message);
    } finally {
      resetFormState();
    }
  });

  // Helper function for CSRF token
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }
});
</script>


<!--<script>-->
<!--document.addEventListener('DOMContentLoaded', function() {-->
<!--  const form = document.getElementById('mpesaPaymentForm');-->
<!--  const submitBtn = document.getElementById('submitBtn');-->
<!--  const phoneInput = document.getElementById('phone');-->
<!--  const paymentStatus = document.getElementById('paymentStatus');-->
<!--  const statusMessage = document.getElementById('statusMessage');-->
<!--  const paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));-->
<!--  const displayPhone = document.getElementById('displayPhone');-->
<!--  const paymentResult = document.getElementById('paymentResult');-->

<!--  function getCookie(name) {-->
<!--    const value = `; ${document.cookie}`;-->
<!--    const parts = value.split(`; ${name}=`);-->
<!--    if (parts.length === 2) return parts.pop().split(';').shift();-->
<!--  }-->
<!--  const csrftoken = getCookie('csrftoken');-->

<!--  function normalizePhoneForUI(phone) {-->
<!--    phone = (phone || '').replace(/\D/g,'');-->
<!--    if (phone.startsWith('0') && phone.length === 10) return '254' + phone.slice(1);-->
<!--    if (phone.startsWith('7') && phone.length === 9) return '254' + phone;-->
<!--    if (phone.startsWith('+254') && phone.length === 13) return phone.slice(1);-->
<!--    return phone;-->
<!--  }-->
<!--  function validatePhone(phone) { return /^2547\d{8}$/.test(phone); }-->

<!--  async function pollStatus(checkoutRequestId) {-->
<!--    const max = 15;-->
<!--    let attempt = 0;-->
<!--    while (attempt < max) {-->
<!--      attempt++;-->
<!--      statusMessage.textContent = `Checking payment status (${attempt}/${max})...`;-->
<!--      try {-->
<!--        const res = await fetch(`/payments/check-status/?checkout_request_id=${checkoutRequestId}`, {-->
<!--          method: 'GET',-->
<!--          credentials: 'include',-->
<!--          headers: { 'X-CSRFToken': csrftoken }-->
<!--        });-->
<!--        if (!res.ok) {-->
<!--          // If 401/403 -> user not authenticated or CSRF issue-->
<!--          throw new Error(`Server status ${res.status}`);-->
<!--        }-->
<!--        const data = await res.json();-->
<!--        if (data.status === 'success') {-->
<!--          paymentResult.innerHTML = `<div class="alert alert-success">Payment complete â€” Redirectingâ€¦</div>`;-->
<!--          setTimeout(()=> window.location.href = `/payments/success/${data.transaction_id}/`, 1200);-->
<!--          return;-->
<!--        } else if (data.status === 'failed') {-->
<!--          throw new Error(data.message || 'Payment failed');-->
<!--        }-->
<!--        // not yet done-->
<!--        await new Promise(r => setTimeout(r, 2000 * Math.pow(1.4, attempt))); // backoff-->
<!--      } catch (err) {-->
<!--        console.error('pollStatus error', err);-->
<!--        if (attempt >= max) {-->
<!--          paymentResult.innerHTML = `<div class="alert alert-warning">Payment is taking too long. Check your M-Pesa messages or transaction history.</div>`;-->
<!--          return;-->
<!--        }-->
<!--      }-->
<!--    }-->
<!--  }-->

<!--  form.addEventListener('submit', async function(e) {-->
<!--    e.preventDefault();-->
<!--    submitBtn.disabled = true;-->
<!--    const phone = normalizePhoneForUI(phoneInput.value);-->
<!--    const amount = form.querySelector('input[name="amount"]').value;-->
<!--    const event_id = form.querySelector('input[name="event_id"]').value;-->

<!--    if (!validatePhone(phone)) {-->
<!--      alert('Enter M-Pesa phone in format 2547XXXXXXXX');-->
<!--      submitBtn.disabled = false;-->
<!--      return;-->
<!--    }-->

<!--    displayPhone.textContent = phone;-->
<!--    paymentModal.show();-->
<!--    statusMessage.textContent = 'Initiating payment request...';-->
<!--    paymentStatus.classList.remove('d-none');-->
<!--    paymentStatus.classList.remove('alert-danger');-->
<!--    paymentStatus.classList.add('alert-info');-->

<!--    try {-->
<!--      const res = await fetch('/payments/initiate-stk-push/', {-->
<!--        method: 'POST',-->
<!--        credentials: 'include',               // important to send session cookie-->
<!--        headers: {-->
<!--          'Content-Type': 'application/json',-->
<!--          'X-CSRFToken': csrftoken-->
<!--        },-->
<!--        body: JSON.stringify({ phone, amount, event_id })-->
<!--      });-->

<!--      if (!res.ok) {-->
<!--        // try to parse JSON error from server-->
<!--        let errObj = null;-->
<!--        try { errObj = await res.json(); } catch(_) {}-->
<!--        throw new Error(errObj?.message || `Server error ${res.status}`);-->
<!--      }-->

<!--      const data = await res.json();-->
<!--      if (!data.success) throw new Error(data.message || 'Failed to initiate payment');-->

<!--      statusMessage.textContent = 'STK Push sent. Check your phone and enter your M-Pesa PIN.';-->
<!--      // start polling-->
<!--      await pollStatus(data.checkout_request_id);-->

<!--    } catch (err) {-->
<!--      console.error('Payment initiation error', err);-->
<!--      paymentStatus.classList.remove('alert-info');-->
<!--      paymentStatus.classList.add('alert-danger');-->
<!--      statusMessage.textContent = err.message || 'Payment error';-->
<!--      paymentResult.innerHTML = `<div class="alert alert-danger">${err.message}</div>`;-->
<!--    } finally {-->
<!--      submitBtn.disabled = false;-->
<!--    }-->
<!--  });-->
<!--});-->
<!--</script>-->



<!--<script>-->
<!--document.addEventListener('DOMContentLoaded', function() {-->
<!--    const form = document.getElementById('mpesaPaymentForm');-->
<!--    const submitBtn = document.getElementById('submitBtn');-->
<!--    const paymentStatus = document.getElementById('paymentStatus');-->
<!--    const statusMessage = document.getElementById('statusMessage');-->
<!--    const paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));-->
<!--    const displayPhone = document.getElementById('displayPhone');-->
<!--    const paymentResult = document.getElementById('paymentResult');-->
<!--    const phoneInput = document.getElementById('phone');-->

<!--    // Function to get CSRF token from cookies-->
<!--    function getCookie(name) {-->
<!--        let cookieValue = null;-->
<!--        if (document.cookie && document.cookie !== '') {-->
<!--            const cookies = document.cookie.split(';');-->
<!--            for (let i = 0; i < cookies.length; i++) {-->
<!--                const cookie = cookies[i].trim();-->
<!--                if (cookie.substring(0, name.length + 1) === (name + '=')) {-->
<!--                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));-->
<!--                    break;-->
<!--                }-->
<!--            }-->
<!--        }-->
<!--        return cookieValue;-->
<!--    }-->

<!--    const csrftoken = getCookie('csrftoken');-->

<!--    // Format phone number to 2547XXXXXXXX format-->
<!--    function formatPhoneNumber(phone) {-->
<!--        phone = phone.replace(/\D/g, '');-->
<!--        if (phone.startsWith('0') && phone.length === 10) {-->
<!--            return '254' + phone.substring(1);-->
<!--        } else if (phone.startsWith('7') && phone.length === 9) {-->
<!--            return '254' + phone;-->
<!--        } else if (phone.startsWith('+254') && phone.length === 13) {-->
<!--            return phone.substring(1);-->
<!--        }-->
<!--        return phone;-->
<!--    }-->

<!--    // Validate phone number format-->
<!--    function validatePhoneNumber(phone) {-->
<!--        return phone && /^2547\d{8}$/.test(phone);-->
<!--    }-->

<!--    // Show error message-->
<!--    function showError(message, isFatal = false) {-->
<!--        statusMessage.textContent = message;-->
<!--        paymentStatus.classList.remove('alert-info');-->
<!--        paymentStatus.classList.add('alert-danger');-->
<!--        paymentStatus.classList.remove('d-none');-->
<!--        submitBtn.disabled = false;-->

<!--        if (isFatal) {-->
<!--            paymentResult.innerHTML = `-->
<!--                <div class="alert alert-danger mt-3">-->
<!--                    <i class="fas fa-exclamation-circle me-2"></i>-->
<!--                    ${message}-->
<!--                </div>-->
<!--            `;-->
<!--            paymentModal.hide();-->
<!--        }-->
<!--    }-->

<!--    // Show success message-->
<!--    function showSuccess(message) {-->
<!--        paymentResult.innerHTML = `-->
<!--            <div class="alert alert-success mt-3">-->
<!--                <i class="fas fa-check-circle me-2"></i>-->
<!--                ${message}-->
<!--            </div>-->
<!--        `;-->
<!--    }-->

<!--    // Poll payment status with exponential backoff-->
<!--    async function pollPaymentStatus(checkoutRequestId) {-->
<!--        const maxAttempts = 15; // Increased from 10 to 15-->
<!--        const initialDelay = 2000;-->
<!--        let attempts = 0;-->

<!--        while (attempts < maxAttempts) {-->
<!--            attempts++;-->
<!--            const delay = initialDelay * Math.pow(1.5, attempts - 1); // Exponential backoff-->
<!--            statusMessage.textContent = `Checking payment status (${attempts}/${maxAttempts})...`;-->

<!--            try {-->
<!--                const response = await fetch(`/payments/check-status/?checkout_request_id=${checkoutRequestId}`, {-->
<!--                    headers: {-->
<!--                        "X-CSRFToken": csrftoken-->
<!--                    },-->
<!--                    credentials: 'include'-->
<!--                });-->

<!--                if (!response.ok) {-->
<!--                    throw new Error(`Server error: ${response.status}`);-->
<!--                }-->

<!--                const data = await response.json();-->

<!--                if (data.status === 'success') {-->
<!--                    showSuccess('Payment successful! Redirecting...');-->
<!--                    setTimeout(() => {-->
<!--                        window.location.href = `/payments/success/${data.transaction_id}/`;-->
<!--                    }, 2000);-->
<!--                    return true;-->
<!--                } else if (data.status === 'failed') {-->
<!--                    throw new Error(data.message || 'Payment failed');-->
<!--                }-->

<!--                await new Promise(resolve => setTimeout(resolve, delay));-->

<!--            } catch (error) {-->
<!--                console.error('Polling error:', error);-->
<!--                if (attempts === maxAttempts) {-->
<!--                    throw new Error('Payment processing took too long. Please check your M-Pesa messages or transaction history.');-->
<!--                }-->
<!--            }-->
<!--        }-->
<!--        return false;-->
<!--    }-->

<!--    // Form submission handler-->
<!--    form.addEventListener('submit', async function(e) {-->
<!--        e.preventDefault();-->

<!--        // Validate phone number-->
<!--        const formattedPhone = formatPhoneNumber(phoneInput.value);-->
<!--        if (!validatePhoneNumber(formattedPhone)) {-->
<!--            showError('Please enter a valid Safaricom number (formats: 2547XXXXXXXX, 07XXXXXXXX, or +2547XXXXXXXX)', true);-->
<!--            phoneInput.focus();-->
<!--            return;-->
<!--        }-->

<!--        // Prepare UI-->
<!--        submitBtn.disabled = true;-->
<!--        paymentStatus.classList.remove('d-none', 'alert-danger');-->
<!--        paymentStatus.classList.add('alert-info');-->
<!--        statusMessage.textContent = "Initiating payment request...";-->

<!--        // Prepare payment data-->
<!--        const paymentData = {-->
<!--            phone: formattedPhone,-->
<!--            amount: form.querySelector('input[name="amount"]').value,-->
<!--            event_id: form.querySelector('input[name="event_id"]').value-->
<!--        };-->

<!--        try {-->
<!--            // Show payment modal-->
<!--            displayPhone.textContent = formattedPhone;-->
<!--            paymentModal.show();-->

<!--            // Prepare headers-->
<!--            const headers = {-->
<!--                "Content-Type": "application/json",-->
<!--                "X-CSRFToken": csrftoken-->
<!--            };-->

<!--            // Add auth token if available-->
<!--            {% if user.is_authenticated %}-->
<!--                headers["Authorization"] = "Token {{ user.auth_token.key }}";-->
<!--            {% endif %}-->

<!--            // Initiate STK Push-->
<!--            const response = await fetch("/payments/initiate-stk-push/", {-->
<!--                method: 'POST',-->
<!--                headers: headers,-->
<!--                credentials: 'include',-->
<!--                body: JSON.stringify(paymentData)-->
<!--            });-->

<!--            if (!response.ok) {-->
<!--                const errorData = await response.json();-->
<!--                throw new Error(errorData.message || `Payment initiation failed (HTTP ${response.status})`);-->
<!--            }-->

<!--            const data = await response.json();-->

<!--            if (!data.success) {-->
<!--                throw new Error(data.message || 'Failed to initiate payment');-->
<!--            }-->

<!--            statusMessage.textContent = "Payment request sent. Please check your phone and enter your M-Pesa PIN.";-->

<!--            // Poll for payment status-->
<!--            const paymentCompleted = await pollPaymentStatus(data.checkout_request_id);-->

<!--            if (!paymentCompleted) {-->
<!--                throw new Error('Payment processing took too long. Please check your M-Pesa messages or transaction history.');-->
<!--            }-->

<!--        } catch (error) {-->
<!--            console.error('Payment Error:', error);-->
<!--            showError(error.message, true);-->
<!--        } finally {-->
<!--            submitBtn.disabled = false;-->
<!--        }-->
<!--    });-->

<!--    // Phone number input validation with better UX-->
<!--    phoneInput.addEventListener('input', function() {-->
<!--        const formatted = formatPhoneNumber(this.value);-->
<!--        const isValid = validatePhoneNumber(formatted);-->

<!--        if (isValid) {-->
<!--            this.classList.add('is-valid');-->
<!--            this.classList.remove('is-invalid');-->
<!--        } else {-->
<!--            this.classList.add('is-invalid');-->
<!--            this.classList.remove('is-valid');-->
<!--        }-->

<!--        // Enable/disable submit button based on validation-->
<!--        submitBtn.disabled = !isValid || !form.querySelector('input[name="amount"]').value;-->
<!--    });-->

<!--    // Amount input validation-->
<!--    form.querySelector('input[name="amount"]').addEventListener('input', function() {-->
<!--        submitBtn.disabled = !validatePhoneNumber(formatPhoneNumber(phoneInput.value)) || !this.value;-->
<!--    });-->
<!--});-->
<!--</script>-->

{% endblock %}
{% extends 'base.html' %}

{% block content %}
<!-- Payment Processing Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Complete Payment</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center py-4">
                <div class="mb-3">
                    <i class="fas fa-mobile-alt fa-4x text-primary mb-3"></i>
                    <h4>Check Your Phone</h4>
                    <p class="mb-0">We've sent an STK Push request to <strong id="displayPhone"></strong></p>
                    <p>Enter your M-Pesa PIN to complete payment</p>
                </div>
                <div class="progress mb-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                </div>
                <div id="paymentResult"></div>
                <div id="countdownTimer" class="mt-2 small text-muted"></div>
            </div>
        </div>
    </div>
</div>

<style>
    .card {
        border-radius: 0.5rem;
        border: none;
    }
    .card-header {
        border-radius: 0.5rem 0.5rem 0 0 !important;
    }
    .event-details {
        background-color: #f8f9fa;
    }
    .btn-success {
        background-color: #28a745;
        border: none;
        font-size: 0.9rem;
        transition: all 0.2s;
    }
    .btn-success:hover {
        background-color: #218838;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .form-control-sm {
        padding: 0.3rem 0.5rem;
    }
    .input-group-text {
        padding: 0.3rem 0.75rem;
    }
    .is-valid {
        border-color: #28a745 !important;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%2328a745' d='M2.3 6.73L.6 4.53c-.4-1.04.46-1.4 1.1-.8l1.1 1.4 3.4-3.8c.6-.63 1.6-.27 1.2.7l-4 4.6c-.43.5-.8.4-1.1.1z'/%3e%3c/svg%3e");
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('mpesaPaymentForm');
    const submitBtn = document.getElementById('submitBtn');
    const paymentStatus = document.getElementById('paymentStatus');
    const statusMessage = document.getElementById('statusMessage');
    const paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
    const displayPhone = document.getElementById('displayPhone');
    const paymentResult = document.getElementById('paymentResult');
    const countdownTimer = document.getElementById('countdownTimer');
    const phoneInput = document.getElementById('phone');

    // Configuration
    const config = {
        maxPollingAttempts: 10,
        pollingInterval: 3000,
        timeoutDuration: 30000 // 30 seconds
    };

    // Format phone number to 2547XXXXXXXX format
    function formatPhoneNumber(phone) {
        phone = phone.replace(/\D/g, ''); // Remove all non-digit characters

        if (phone.startsWith('0') && phone.length === 10) {
            return '254' + phone.substring(1);
        } else if (phone.startsWith('7') && phone.length === 9) {
            return '254' + phone;
        } else if (phone.startsWith('254') && phone.length === 12) {
            return phone;
        }
        return null;
    }

    // Validate phone number format
    function validatePhoneNumber(phone) {
        return phone && /^2547\d{8}$/.test(phone);
    }

    // Show error message
    function showError(message, isFatal = false) {
        statusMessage.textContent = message;
        paymentStatus.classList.remove('alert-info');
        paymentStatus.classList.add('alert-danger');
        submitBtn.disabled = false;

        if (isFatal) {
            paymentResult.innerHTML = `
                <div class="alert alert-danger mt-3">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    ${message}
                </div>
            `;
            paymentModal.hide();
        }
    }

    // Start countdown timer
    function startCountdown(duration, element) {
        let timer = duration;
        const interval = setInterval(function() {
            const minutes = parseInt(timer / 60, 10);
            const seconds = parseInt(timer % 60, 10);

            element.textContent = `Time remaining: ${minutes}:${seconds < 10 ? "0" + seconds : seconds}`;

            if (--timer < 0) {
                clearInterval(interval);
                element.textContent = "Payment session expired";
            }
        }, 1000);

        return interval;
    }

    // Poll payment status
    async function pollPaymentStatus(checkoutRequestId) {
        let attempts = 0;
        let timerInterval;

        try {
            // Start timeout countdown
            timerInterval = startCountdown(config.timeoutDuration / 1000, countdownTimer);

            while (attempts < config.maxPollingAttempts) {
                attempts++;

                try {
                    const response = await fetch(`/payments/check-status/?checkout_request_id=${checkoutRequestId}`);

                    if (!response.ok) {
                        throw new Error(`Server returned ${response.status} status`);
                    }

                    const data = await response.json();

                    if (data.status === 'success') {
                        // Payment successful
                        clearInterval(timerInterval);
                        countdownTimer.textContent = "Payment verified!";

                        paymentResult.innerHTML = `
                            <div class="alert alert-success mt-3">
                                <i class="fas fa-check-circle me-2"></i>
                                Payment successful! Redirecting...
                            </div>
                        `;

                        // Redirect to success page
                        setTimeout(() => {
                            window.location.href = `/payments/success/${data.transaction_id}/`;
                        }, 2000);
                        return true;

                    } else if (data.status === 'failed') {
                        throw new Error(data.message || 'Payment failed');
                    }

                    // Wait before next attempt
                    await new Promise(resolve => setTimeout(resolve, config.pollingInterval));

                } catch (error) {
                    console.error('Polling error:', error);
                    if (attempts === config.maxPollingAttempts) {
                        throw new Error('Payment timeout. Please check your M-Pesa messages.');
                    }
                }
            }
        } finally {
            clearInterval(timerInterval);
        }
        return false;
    }

    // Form submission handler
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        e.stopPropagation();

        // Process and validate phone number
        const formattedPhone = formatPhoneNumber(phoneInput.value);

        if (!validatePhoneNumber(formattedPhone)) {
            showError('Please enter a valid Safaricom number (format: 2547XXXXXXXX or 07XXXXXXXX)');
            phoneInput.focus();
            return;
        }

        // Prepare UI for processing
        submitBtn.disabled = true;
        paymentStatus.classList.remove('d-none', 'alert-danger');
        paymentStatus.classList.add('alert-info');
        statusMessage.textContent = "Initiating payment request...";

        // Prepare payment data
        const paymentData = {
            phone: formattedPhone,
            amount: form.querySelector('input[name="amount"]').value,
            event_id: form.querySelector('input[name="event_id"]').value
        };

        try {
            // Show payment modal
            displayPhone.textContent = formattedPhone;
            paymentModal.show();

            // Initiate STK Push
            const response = await fetch("{% url 'payments:initiate_stk_push' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': form.querySelector('input[name="csrfmiddlewaretoken"]').value,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(paymentData)
            });

            // Handle HTTP errors
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || `Payment initiation failed (HTTP ${response.status})`);
            }

            const data = await response.json();

            // Handle API errors
            if (!data.success) {
                throw new Error(data.message || 'Failed to initiate payment');
            }

            // Update UI
            statusMessage.textContent = "Payment request sent. Please check your phone.";

            // Start polling for payment status
            const paymentCompleted = await pollPaymentStatus(data.checkout_request_id);

            if (!paymentCompleted) {
                throw new Error('Payment processing took too long. Please check your M-Pesa messages.');
            }

        } catch (error) {
            console.error('Payment Error:', error);
            showError(error.message, true);
        }
    });

    // Phone number input validation
    phoneInput.addEventListener('input', function() {
        const formatted = formatPhoneNumber(this.value);
        if (formatted && validatePhoneNumber(formatted)) {
            this.classList.remove('is-invalid');
            this.classList.add('is-valid');
        } else {
            this.classList.remove('is-valid');
        }
    });

    // Prevent modal from closing during payment processing
    paymentModal._element.addEventListener('hide.bs.modal', function(event) {
        if (submitBtn.disabled) {
            event.preventDefault();
            showError('Please wait while we process your payment', false);
        }
    });
});
</script>
{% endblock %}